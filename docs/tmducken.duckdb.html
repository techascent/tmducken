<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>tmducken.duckdb documentation</title><script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-XJYNJF48RM"></script><script>window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XJYNJF48RM');</script><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">TMDucken</span> <span class="project-version">0.10.1</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1 current"><a href="tmducken.duckdb.html"><div class="inner"><span>tmducken.duckdb</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="tmducken.duckdb.html#var-close-db"><div class="inner"><span>close-db</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-connect"><div class="inner"><span>connect</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-create-table.21"><div class="inner"><span>create-table!</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-delayed-clone"><div class="inner"><span>delayed-clone</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-disconnect"><div class="inner"><span>disconnect</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-drop-table.21"><div class="inner"><span>drop-table!</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-duckdb-library-version"><div class="inner"><span>duckdb-library-version</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-get-config-options"><div class="inner"><span>get-config-options</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-initialize.21"><div class="inner"><span>initialize!</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-initialized.3F"><div class="inner"><span>initialized?</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-insert-dataset.21"><div class="inner"><span>insert-dataset!</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-open-db"><div class="inner"><span>open-db</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-prepare"><div class="inner"><span>prepare</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-run-query.21"><div class="inner"><span>run-query!</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-sql-.3Edataset"><div class="inner"><span>sql-&gt;dataset</span></div></a></li><li class="depth-1"><a href="tmducken.duckdb.html#var-sql-.3Edatasets"><div class="inner"><span>sql-&gt;datasets</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">tmducken.duckdb</h1><div class="doc"><div class="markdown"><p>DuckDB C-level bindings for tech.ml.dataset.</p>
<p>Current datatype support:</p>
<ul>
<li>boolean, all numeric types int8-&gt;int64, uint8-&gt;uint64, float32, float64.</li>
<li>string</li>
<li>uuid</li>
<li>LocalDate, Instant column types.</li>
</ul>
<p>Example:</p>
<pre><code class="language-clojure">
user&gt; (require '[tech.v3.dataset :as ds])
nil
user&gt; (require '[tmducken.duckdb :as duckdb])
nil
user&gt; (duckdb/initialize!)
10:04:14.814 [nREPL-session-635e9bc8-2923-442b-9fad-da547210617b] INFO tmducken.duckdb - Attempting to load duckdb from "/home/chrisn/dev/cnuernber/tmducken/binaries/libduckdb.so"
true
user&gt; (def stocks
      (-&gt; (ds/-&gt;dataset "https://github.com/techascent/tech.ml.dataset/raw/master/test/data/stocks.csv" {:key-fn keyword})
          (vary-meta assoc :name :stocks)))
#'user/stocks
user&gt; (def db (duckdb/open-db))
#'user/db
user&gt; (def conn (duckdb/connect db))
#'user/conn
user&gt; (duckdb/create-table! conn stocks)
"stocks"
user&gt; (duckdb/insert-dataset! conn stocks)
560
user&gt; (ds/head (duckdb/sql-&gt;dataset conn "select * from stocks"))

_unnamed [5 3]:

| symbol |       date | price |
|--------|------------|------:|
|   MSFT | 2000-01-01 | 39.81 |
|   MSFT | 2000-02-01 | 36.35 |
|   MSFT | 2000-03-01 | 43.22 |
|   MSFT | 2000-04-01 | 28.37 |
|   MSFT | 2000-05-01 | 25.45 |
</code></pre>
</div></div><div class="public anchor" id="var-close-db"><h3>close-db</h3><div class="usage"><code>(close-db db)</code></div><div class="doc"><div class="markdown"><p>Close the database.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L206">view source</a></div></div><div class="public anchor" id="var-connect"><h3>connect</h3><div class="usage"><code>(connect db)</code></div><div class="doc"><div class="markdown"><p>Create a new database connection from an opened database.
Users should call disconnect to close this connection.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L214">view source</a></div></div><div class="public anchor" id="var-create-table.21"><h3>create-table!</h3><div class="usage"><code>(create-table! conn dataset options)</code><code>(create-table! conn dataset)</code></div><div class="doc"><div class="markdown"><p>Create an sql table based off of the column datatypes of the dataset.  Note that users
can also call <a href="execute-query!">execute-query!</a> with their own sql create-table string.  Note that the
fastest way to get data into the system is <a href="tmducken.duckdb.html#var-insert-dataset.21">insert-dataset!</a>.</p>
<p>Options:</p>
<ul>
<li><code>:table-name</code> - Name of the table to create.  If not supplied the dataset name will
be used.</li>
<li><code>:primary-key</code> - sequence of column names to be used as the primary key.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L255">view source</a></div></div><div class="public anchor" id="var-delayed-clone"><h3>delayed-clone</h3><div class="usage"><code>(delayed-clone this)</code></div><div class="doc"><div class="markdown"></div></div></div><div class="public anchor" id="var-disconnect"><h3>disconnect</h3><div class="usage"><code>(disconnect conn)</code></div><div class="doc"><div class="markdown"><p>Disconnect a connection.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L224">view source</a></div></div><div class="public anchor" id="var-drop-table.21"><h3>drop-table!</h3><div class="usage"><code>(drop-table! conn dataset)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L281">view source</a></div></div><div class="public anchor" id="var-duckdb-library-version"><h3>duckdb-library-version</h3><div class="usage"><code>(duckdb-library-version)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L93">view source</a></div></div><div class="public anchor" id="var-get-config-options"><h3>get-config-options</h3><div class="usage"><code>(get-config-options)</code></div><div class="doc"><div class="markdown"><p>Returns a sequence of maps of {:name :desc} describing valid valid configuration
options to the open-db function.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L141">view source</a></div></div><div class="public anchor" id="var-initialize.21"><h3>initialize!</h3><div class="usage"><code>(initialize! {:keys [duckdb-home lib-instance]})</code><code>(initialize!)</code></div><div class="doc"><div class="markdown"><p>Initialize the duckdb ffi system.  This must be called first should be called only once.
It is safe, however, to call this multiple times.</p>
<p>Options:</p>
<ul>
<li><code>:duckdb-home</code> - Directory in which to find the duckdb shared library.  Users can pass
this in.  If not passed in, then the environment variable <code>DUCKDB_HOME</code> is checked.  If
neither is passed in then the library will be searched in the normal system library
paths.</li>
</ul>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L106">view source</a></div></div><div class="public anchor" id="var-initialized.3F"><h3>initialized?</h3><div class="usage"><code>(initialized?)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L88">view source</a></div></div><div class="public anchor" id="var-insert-dataset.21"><h3>insert-dataset!</h3><div class="usage"><code>(insert-dataset! conn dataset options)</code><code>(insert-dataset! conn dataset)</code></div><div class="doc"><div class="markdown"><p>Append this dataset using the higher performance append api of duckdb.  This is recommended
as opposed to using sql statements or prepared statements.  That being said the schema of this
dataset must match <em>precisely</em> the schema of the target table.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L322">view source</a></div></div><div class="public anchor" id="var-open-db"><h3>open-db</h3><div class="usage"><code>(open-db path config-options)</code><code>(open-db path)</code><code>(open-db)</code></div><div class="doc"><div class="markdown"><p>Open a database.  <code>path</code> may be nil in which case database is opened in-memory.
For valid config options call <a href="tmducken.duckdb.html#var-get-config-options">get-config-options</a>.  Options must be
passed as a map of string-&gt;string.  As duckdb is dynamically linked configuration options
may change but with <code>linux-amd64-0.3.1</code> current options are:</p>
<pre><code class="language-clojure">tmducken.duckdb&gt; (get-config-options)
[{:name "access_mode",
  :desc "Access mode of the database ([AUTOMATIC], READ_ONLY or READ_WRITE)"}
 {:name "default_order",
  :desc "The order type used when none is specified ([ASC] or DESC)"}
 {:name "default_null_order",
  :desc "Null ordering used when none is specified ([NULLS_FIRST] or NULLS_LAST)"}
 {:name "enable_external_access",
  :desc
  "Allow the database to access external state (through e.g. COPY TO/FROM, CSV readers, pandas replacement scans, etc)"}
 {:name "enable_object_cache",
  :desc "Whether or not object cache is used to cache e.g. Parquet metadata"}
 {:name "max_memory", :desc "The maximum memory of the system (e.g. 1GB)"}
 {:name "threads", :desc "The number of total threads used by the system"}]
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L155">view source</a></div></div><div class="public anchor" id="var-prepare"><h3>prepare</h3><div class="usage"><code>(prepare conn sql)</code><code>(prepare conn sql options)</code></div><div class="doc"><div class="markdown"><p>Create a prepared statement returning a clojure function you can call taking args specified
in the prepared statement.  This function is auto-closeable which releases the prepared statement - it is also
registered with the resource system so it will be released when it is no longer reachable by the gc system.</p>
<p>The function return value can be either a sequence of datasets or a single dataset.  For <code>:streaming</code>, the sequence
is read from the result and has no count.  For <code>:realized</code> the sequence is of known length and the result
is completely realized before the first dataset is read.  Finally you can have <code>single</code> which means
the system will return a single dataset.  The default is <code>:streaming</code>.</p>
<p>In the cases where a sequence is returned, the object returned is auto-closeable result object itself will
be destroyed when the object is closed or when it is no longer reachable.</p>
<p>In general datasets are copied into the JVM on a chunk-by-chunk basis.  If the user simply desires to reduce over
the return value the datasets can be zero-copied during the reduction with an option to immediately release
each dataset.  It is extremely quick to clone the dataset into jvm heap storage, however, so please stick with
the defaults - which are safe and memory efficient - unless you have a very good reason to change them.</p>
<p>Options are passed through to dataset creation.</p>
<p>Options:</p>
<ul>
<li><code>:result-type</code> - one of <code>#{:streaming :realized :single}</code> - defaulting to <code>:streaming</code>.
<ul>
<li><code>:streaming</code> - uncountable supplier/sequence of datasets - auto-closeable.</li>
<li><code>:realized</code> - all results realized, countable supplier/sequence of datasets - auto-closeable.</li>
<li><code>:single</code> - results realized into a single dataset with chunks and result being immediately released.</li>
</ul>
</li>
<li><code>:reduce-type - One of #{:clone :zero-copy-imm :zero-copy}</code> defaulting to <code>:clone</code>.  - When the result is
reduced the dataset is initially read via zero-copy directly from the result batch.  Then one of three things happen:
<ul>
<li><code>:clone</code> - dataset cloned and batch released just before rf - safest option and default.</li>
<li><code>:zero-copy-imm</code> - rf called with zero-copy dataset and batch released just after.  This is very memory and cpu efficient
but you need to ensure that no part of the dataset escapes rf.</li>
<li><code>:zero-copy</code> - Datasets are merely passed to rf and batch is not released but is registered with the resource system.  This
is used to efficiently concatenate the results into one dataset after which all batches are released.</li>
</ul>
</li>
</ul>
<p>Examples:</p>
<pre><code class="language-clojure">user&gt; (def stmt (duckdb/prepare conn "select * from stocks"))
Aug 31, 2023 8:52:25 AM clojure.tools.logging$eval5800$fn__5803 invoke
INFO: Reference thread starting
#'user/stmt
user&gt; stmt
#duckdb-prepared-statement-0["select * from stocks"]
user&gt; (stmt)
#duckdb-streaming-result["select * from stocks"]
user&gt; (ds/head (first *1))
_unnamed [5 3]:

| symbol |       date | price |
|--------|------------|------:|
|   MSFT | 2000-01-01 | 39.81 |
|   MSFT | 2000-02-01 | 36.35 |
|   MSFT | 2000-03-01 | 43.22 |
|   MSFT | 2000-04-01 | 28.37 |
|   MSFT | 2000-05-01 | 25.45 |
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L1144">view source</a></div></div><div class="public anchor" id="var-run-query.21"><h3>run-query!</h3><div class="usage"><code>(run-query! conn sql options)</code><code>(run-query! conn sql)</code></div><div class="doc"><div class="markdown"><p>Run a query ignoring the results.  Useful for queries such as single-row insert or update where
you don't care about the results.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L232">view source</a></div></div><div class="public anchor" id="var-sql-.3Edataset"><h3>sql-&gt;dataset</h3><div class="usage"><code>(sql-&gt;dataset conn sql options)</code><code>(sql-&gt;dataset conn sql)</code></div><div class="doc"><div class="markdown"><p>Execute a query returning a single dataset.  This runs the query in a context that releases the memory used
for the result set before function returns returning a dataset that has no native bindings.</p>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L903">view source</a></div></div><div class="public anchor" id="var-sql-.3Edatasets"><h3>sql-&gt;datasets</h3><div class="usage"><code>(sql-&gt;datasets conn sql options)</code><code>(sql-&gt;datasets conn sql)</code></div><div class="doc"><div class="markdown"><p>Execute a query returning either a sequence of datasets or a single dataset.</p>
<p>See documentation and options for <a href="tmducken.duckdb.html#var-prepare">prepare</a>.</p>
<p>Examples:</p>
<pre><code class="language-clojure">tmducken.duckdb&gt; (first (sql-&gt;datasets conn "select * from stocks"))
_unnamed [560 3]:

| symbol |       date | price |
|--------|------------|------:|
|   MSFT | 2000-01-01 | 39.81 |
|   MSFT | 2000-02-01 | 36.35 |
|   MSFT | 2000-03-01 | 43.22 |
|   MSFT | 2000-04-01 | 28.37 |
|   MSFT | 2000-05-01 | 25.45 |
|   MSFT | 2000-06-01 | 32.54 |
|   MSFT | 2000-07-01 | 28.40 |



tmducken.duckdb&gt; (ds/head (sql-&gt;dataset conn "select * from stocks"))
_unnamed [5 3]:

| symbol |       date | price |
|--------|------------|------:|
|   MSFT | 2000-01-01 | 39.81 |
|   MSFT | 2000-02-01 | 36.35 |
|   MSFT | 2000-03-01 | 43.22 |
|   MSFT | 2000-04-01 | 28.37 |
|   MSFT | 2000-05-01 | 25.45 |
</code></pre>
</div></div><div class="src-link"><a href="https://github.com/techascent/tmducken/blob/master/src/tmducken/duckdb.clj#L861">view source</a></div></div></div></body></html>